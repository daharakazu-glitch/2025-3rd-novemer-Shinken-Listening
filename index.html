<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- ãƒ«ãƒ¼ãƒ«â‘ : æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã®è¡¨ç´™ã‚’å‚è€ƒã«ã‚¿ã‚¤ãƒˆãƒ«ã‚’è¨­å®š -->
    <title>2025å¹´åº¦ 3å¹´11æœˆ é€²ç ”æ¨¡è©¦ è‹±èªãƒªã‚¹ãƒ‹ãƒ³ã‚° é‡è¦èªå¥å¾©ç¿’ã‚¢ãƒ—ãƒª</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
        }
        .card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 24px;
            transition: all 0.3s ease-in-out;
            position: relative; /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã®ãŸã‚ */
        }
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }
        .btn-primary:hover {
            background-color: #2563eb;
        }
        .btn-secondary {
            background-color: #6b7280;
            color: white;
        }
         .btn-secondary:hover {
            background-color: #4b5563;
        }
        .btn-green {
            background-color: #10b981;
            color: white;
        }
        .btn-green:hover {
            background-color: #059669;
        }
        .btn-red {
            background-color: #ef4444;
            color: white;
        }
        .btn-disabled {
            background-color: #d1d5db;
            cursor: not-allowed;
        }
        .hidden {
            display: none;
        }
        .quiz-option {
            border: 2px solid #e5e7eb;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .quiz-option:hover {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        .quiz-option.selected {
            border-color: #3b82f6;
            background-color: #dbeafe;
        }
        .quiz-option.correct {
            border-color: #10b981;
            background-color: #d1fae5;
        }
        .quiz-option.incorrect {
            border-color: #ef4444;
            background-color: #fee2e2;
        }
        #mic-icon.recording {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        .pronunciation-feedback {
            font-size: 1.5rem;
            font-weight: bold;
            margin-top: 1rem;
            min-height: 40px;
        }
        .feedback-great { color: #10b981; }
        .feedback-good { color: #f59e0b; }
        .feedback-retry { color: #ef4444; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="app" class="max-w-3xl mx-auto p-4 sm:p-6">
        <header class="text-center mb-6">
            <!-- ãƒ«ãƒ¼ãƒ«â‘ : æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã®è¡¨ç´™ã‚’å‚è€ƒã«ã‚¿ã‚¤ãƒˆãƒ«ã‚’è¨­å®š -->
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">2025å¹´åº¦ 3å¹´11æœˆ é€²ç ”æ¨¡è©¦ è‹±èªãƒªã‚¹ãƒ‹ãƒ³ã‚° é‡è¦èªå¥å¾©ç¿’ã‚¢ãƒ—ãƒª</h1>
        </header>

        <!-- Setup Section -->
        <section id="setup-section" class="card space-y-6">
            <div>
                <h2 class="text-2xl font-bold mb-3">1. å­¦ç¿’ã™ã‚‹å˜èªã‚’é¸æŠ</h2>
                <div class="flex space-x-2 mb-3">
                    <button id="select-all" class="btn btn-secondary text-sm px-3 py-1">ã™ã¹ã¦é¸æŠ</button>
                    <button id="deselect-all" class="btn btn-secondary text-sm px-3 py-1">ã™ã¹ã¦è§£é™¤</button>
                </div>
                <div id="word-list" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2 max-h-60 overflow-y-auto p-2 border rounded-lg">
                    <!-- Word checkboxes will be inserted here -->
                </div>
            </div>

            <div>
                <h2 class="text-2xl font-bold mb-3">2. å­¦ç¿’ãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠ</h2>
                <div class="flex space-x-4">
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="radio" name="mode" value="word" class="form-radio h-5 w-5 text-blue-600" checked>
                        <span>å˜èªãƒ»ãƒ•ãƒ¬ãƒ¼ã‚ºã®ã¿</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="radio" name="mode" value="sentence" class="form-radio h-5 w-5 text-blue-600">
                        <span>ä¾‹æ–‡ã§å­¦ç¿’</span>
                    </label>
                </div>
            </div>

            <!-- ãƒ«ãƒ¼ãƒ«â‘£: ä¾‹æ–‡ç”Ÿæˆã®ãŸã‚ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º -->
            <div id="loading-overlay" class="hidden absolute inset-0 bg-white bg-opacity-75 flex items-center justify-center rounded-lg z-10">
                <div class="text-center">
                    <i class="fas fa-spinner fa-spin text-4xl text-blue-600"></i>
                    <p class="mt-4 text-lg font-semibold text-gray-700">ä¾‹æ–‡ã‚’ç”Ÿæˆä¸­ã§ã™...</p>
                </div>
            </div>

            <div class="text-center sm:flex sm:flex-col md:flex-row md:justify-center md:items-center">
                <button id="start-learning-btn" class="btn btn-primary w-full md:w-auto text-lg mb-3 md:mb-0 md:mr-4">å­¦ç¿’ã‚’é–‹å§‹ã™ã‚‹</button>
                <button id="download-pdf-btn" class="btn btn-green w-full md:w-auto text-lg">PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
            </div>
        </section>

        <!-- Learning Section -->
        <section id="learning-section" class="card hidden text-center">
            <div class="mb-4 text-right">
                <span id="progress-indicator" class="text-lg font-bold text-gray-600"></span>
            </div>
            
            <div id="flashcard-container" class="mb-4 min-h-[150px] flex items-center justify-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer bg-white hover:bg-gray-50 transition" title="ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç­”ãˆã‚’è¡¨ç¤º">
                <div class="text-center">
                    <p id="english-text" class="text-3xl sm:text-4xl font-bold"></p>
                    <p id="japanese-text" class="text-xl text-gray-700 mt-4 hidden"></p>
                </div>
            </div>
            
            <!-- ãƒ«ãƒ¼ãƒ«â‘§: ç™ºéŸ³è©•ä¾¡ã®è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
            <div id="pronunciation-feedback-container" class="pronunciation-feedback"></div>

            <div class="flex justify-center items-center space-x-4 mb-8">
                <!-- ãƒ«ãƒ¼ãƒ«â‘¥: éŸ³å£°å†ç”Ÿãƒœã‚¿ãƒ³ -->
                <button id="speak-btn" class="btn btn-primary"><i class="fas fa-volume-up mr-2"></i>éŸ³å£°</button>
                <!-- ãƒ«ãƒ¼ãƒ«â‘§: éŒ²éŸ³ãƒœã‚¿ãƒ³ -->
                <button id="record-btn" class="btn btn-red"><i id="mic-icon" class="fas fa-microphone mr-2"></i>éŒ²éŸ³</button>
                <button id="play-recording-btn" class="btn btn-green btn-disabled" disabled><i class="fas fa-play mr-2"></i>è‡ªåˆ†ã®éŸ³å£°</button>
            </div>
            <audio id="recording-player" class="hidden"></audio>

            <div class="flex justify-between">
                <button id="prev-btn" class="btn btn-secondary"><i class="fas fa-arrow-left mr-2"></i>å‰ã¸</button>
                <div class="flex space-x-2">
                    <button id="back-to-setup-btn" class="btn btn-secondary bg-gray-400 hover:bg-gray-500">å˜èªé¸æŠã«æˆ»ã‚‹</button>
                    <button id="start-test-btn" class="btn btn-primary">ãƒ†ã‚¹ãƒˆã¸é€²ã‚€</button>
                </div>
                <button id="next-btn" class="btn btn-secondary">æ¬¡ã¸<i class="fas fa-arrow-right ml-2"></i></button>
            </div>
        </section>

        <!-- Test Options Section -->
        <section id="test-options-section" class="card hidden text-center">
            <h2 class="text-2xl font-bold mb-6">æœ€çµ‚ãƒ†ã‚¹ãƒˆ</h2>
            <p class="text-gray-600 mb-6">å­¦ç¿’ã—ãŸå˜èªã®ä¸­ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã§å‡ºé¡Œã—ã¾ã™ã€‚<br>å•é¡Œæ•°ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p>
            <div id="test-choices" class="flex justify-center space-x-4">
            </div>
             <button id="back-to-learning-btn" class="btn btn-secondary mt-6 bg-gray-400 hover:bg-gray-500">å­¦ç¿’ã«æˆ»ã‚‹</button>
        </section>

        <!-- Quiz Section -->
        <section id="quiz-section" class="card hidden">
            <div class="flex justify-between items-center mb-4">
                 <h2 class="text-2xl font-bold">ãƒ†ã‚¹ãƒˆä¸­</h2>
                 <div>
                    <button id="abort-test-btn" class="btn btn-secondary text-sm px-3 py-1">å­¦ç¿’ã«æˆ»ã‚‹</button>
                    <span id="quiz-progress" class="text-lg font-bold text-gray-600 ml-4"></span>
                 </div>
            </div>
            <div class="mb-6">
                <p id="quiz-question" class="text-center text-3xl font-bold mb-6"></p>
                <div id="quiz-options" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                </div>
            </div>
             <div id="feedback" class="text-center text-xl font-bold my-4 min-h-[30px]"></div>
            <div class="text-center">
                 <button id="next-question-btn" class="btn btn-primary hidden w-full sm:w-auto">æ¬¡ã®å•é¡Œã¸</button>
            </div>
        </section>

        <!-- Results Section -->
        <section id="results-section" class="card hidden text-center">
            <h2 class="text-3xl font-bold mb-4">ãƒ†ã‚¹ãƒˆçµæœ</h2>
            <p id="score" class="text-5xl font-bold text-blue-600 mb-6"></p>
            <div id="incorrect-answers-container" class="text-left">
                <h3 class="text-xl font-bold mb-3">é–“é•ãˆãŸå•é¡Œ</h3>
                <ul id="incorrect-answers-list" class="space-y-2 list-disc list-inside">
                </ul>
            </div>
            <button id="restart-btn" class="btn btn-primary mt-8 w-full sm:w-auto text-lg">ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦ã™ã‚‹</button>
        </section>

    </div>

    <!-- PDF Download Modal -->
    <!-- ãƒ«ãƒ¼ãƒ«â‘£, â‘¦: 6ç¨®é¡ã®PDFãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ -->
    <div id="pdf-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
        <div class="relative mx-auto p-5 border w-11/12 md:w-1/2 lg:w-1/3 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹PDFã®ç¨®é¡ã‚’é¸æŠ</h3>
                <div class="mt-4 px-7 py-3 space-y-3">
                    <button id="download-list-btn" class="btn btn-primary w-full justify-start">1. å®Œå…¨ãªå˜èªã®ãƒªã‚¹ãƒˆ</button>
                    <button id="download-en-quiz-btn" class="btn btn-primary w-full justify-start">2. è‹±èªã®å˜èªã‚’è§£ç­”ã™ã‚‹å•é¡Œ</button>
                    <button id="download-ja-quiz-btn" class="btn btn-primary w-full justify-start">3. å˜èªã®æ—¥æœ¬èªè¨³ã‚’è§£ç­”ã™ã‚‹å•é¡Œ</button>
                    <button id="download-mixed-quiz-btn" class="btn btn-primary w-full justify-start">4. è‹±èªã¨æ—¥æœ¬èªãŒæ··åœ¨ã—ãŸå•é¡Œ</button>
                    <button id="download-sentence-quiz-btn" class="btn btn-primary w-full justify-start">5. ä¾‹æ–‡ã®ç©´åŸ‹ã‚å•é¡Œ</button>
                    <button id="download-sentence-mixed-quiz-btn" class="btn btn-primary w-full justify-start">6. ä¾‹æ–‡ã®æ··åˆå•é¡Œ (ç©´åŸ‹ã‚/å’Œè¨³)</button>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="close-modal-btn" class="btn btn-secondary w-full">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                </div>
            </div>
        </div>
    </div>


    <script>
        // ãƒ«ãƒ¼ãƒ«â‘¡, â‘¤: æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰æŠ½å‡ºã—ãŸèªå½™ãƒ‡ãƒ¼ã‚¿ï¼ˆç™»å ´é †ï¼‰
        const vocabularyData = [
            {"english": "manage", "japanese": "ãªã‚“ã¨ã‹ã™ã‚‹"},
            {"english": "turn out", "japanese": "ã€œã«ãªã‚‹"},
            {"english": "goods", "japanese": "å•†å“,å“ç‰©;~ç”¨å“"},
            {"english": "nearby", "japanese": "è¿‘ãã«"},
            {"english": "commercial", "japanese": "ã‚³ãƒãƒ¼ã‚·ãƒ£ãƒ«"},
            {"english": "excellent", "japanese": "ã™ã°ã‚‰ã—ã„"},
            {"english": "custom", "japanese": "ã‚ã¤ã‚‰ãˆã®ã€ã‚ªãƒ¼ãƒ€ãƒ¼ãƒ¡ã‚¤ãƒ‰ã®"},
            {"english": "match", "japanese": "ã€œã«å¯¾å¿œã™ã‚‹ã€é©åˆã™ã‚‹"},
            {"english": "comfortable", "japanese": "å¿«é©ãª"},
            {"english": "distance", "japanese": "è·é›¢: é“ã®ã‚Šã€è¡Œç¨‹"},
            {"english": "suspension", "japanese": "(è‡ªå‹•è»Šãªã©ã®) ã‚µã‚¹ãƒšãƒ³ã‚·ãƒ§ãƒ³ã€ç·©è¡è£…ç½®"},
            {"english": "brake", "japanese": "ãƒ–ãƒ¬ãƒ¼ã‚­"},
            {"english": "handling", "japanese": "æ“ä½œ,æ“ç¸¦"},
            {"english": "relate to", "japanese": "ã€œã«å…±æ„Ÿã™ã‚‹"},
            {"english": "comedian", "japanese": "ã‚³ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ³"},
            {"english": "childhood", "japanese": "å­ã©ã‚‚ã®é ƒ"},
            {"english": "boring", "japanese": "é€€å±ˆãª"},
            {"english": "delighted", "japanese": "å–œã‚“ã§~ã™ã‚‹"},
            {"english": "second language", "japanese": "ç¬¬äºŒè¨€èª,å¤–å›½èª"},
            {"english": "farming", "japanese": "è¾²æ¥­"},
            {"english": "technique", "japanese": "æŠ€è¡“ã€ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯"},
            {"english": "innovation", "japanese": "å°å…¥,é©æ–°"},
            {"english": "production", "japanese": "ç”Ÿç”£é‡"},
            {"english": "shift", "japanese": "å¤‰åŒ–,ç§»å‹•"},
            {"english": "variety", "japanese": "å¤šæ§˜æ€§;ç¨®é¡"},
            {"english": "wheat", "japanese": "å°éº¦"},
            {"english": "crop", "japanese": "ä½œç‰©,åç©«ç‰©"},
            {"english": "genetic", "japanese": "éºä¼å­ã®"},
            {"english": "diversity", "japanese": "å¤šæ§˜æ€§"},
            {"english": "challenge", "japanese": "è©¦ç·´,é›£é¡Œ"},
            {"english": "seed", "japanese": "ç¨®,ç¨®å­"},
            {"english": "temperature", "japanese": "æ¸©åº¦,æ°—æ¸©"},
            {"english": "unpredictable", "japanese": "äºˆæ¸¬ã§ããªã„"},
            {"english": "due to ~", "japanese": "ã€œãŒåŸå› ã§ã€ã€œã®ãŸã‚"},
            {"english": "fortunately", "japanese": "å¹¸é‹ã«ã‚‚ã€ã‚ã‚ŠãŒãŸã„ã“ã¨ã«ã¯"},
            {"english": "descend", "japanese": "ä¼ã‚ã‚‹ã€éºä¼ã™ã‚‹"},
            {"english": "height", "japanese": "é«˜ã•ã€èº«é•·"},
            {"english": "stiff", "japanese": "ã‹ãŸã„ã€æ›²ãŒã‚Šã«ãã„"},
            {"english": "preferable", "japanese": "å¥½ã¾ã—ã„ã€ã¾ã—ãª"},
            {"english": "yield", "japanese": "ç”¢å‡ºé«˜,åç©«(é‡)"},
            {"english": "significant", "japanese": "ã‹ãªã‚Šã®è‘—ã—ã„"},
            {"english": "advantage", "japanese": "æœ‰åˆ©ãªç‚¹ã€åˆ©ç‚¹"},
            {"english": "resist", "japanese": "ã€œã«è€ãˆã‚‹ã€å®³ã•ã‚Œãªã„"},
            {"english": "fertilizer", "japanese": "è‚¥æ–™"},
            {"english": "emit", "japanese": "ã€œã‚’å‡ºã™ã€æ”¾ã¤"},
            {"english": "carbon", "japanese": "ç‚­ç´ "},
            {"english": "restore", "japanese": "ã€œã‚’å›å¾©ã™ã‚‹ã€å¾©æ´»ã•ã›ã‚‹"},
            {"english": "characteristic", "japanese": "ç‰¹å¾µ,ç‰¹è³ª"},
            {"english": "combine", "japanese": "ã€œã‚’çµ„ã¿åˆã‚ã›ã‚‹ã€çµåˆã•ã›ã‚‹"},
            {"english": "vegetarian", "japanese": "èœé£Ÿä¸»ç¾©è€…ã€ãƒ™ã‚¸ã‚¿ãƒªã‚¢ãƒ³"},
            {"english": "environmental", "japanese": "ç’°å¢ƒä¿è­·ã®"},
            {"english": "contribute", "japanese": "ä¸€å› ã¨ãªã‚‹"},
            {"english": "you know", "japanese": "ã€œã§ã—ã‚‡ã€ã€œãªã‚“ã§ã™ã­"},
            {"english": "overseas", "japanese": "æµ·å¤–ã«æµ·å¤–ã®"},
            {"english": "tip", "japanese": "ãƒ’ãƒ³ãƒˆã€ç§˜è¨£"},
            {"english": "domestic", "japanese": "å›½å†…ã®ã€è‡ªå›½ã®"},
            {"english": "accommodations", "japanese": "å®¿æ³Šæ–½è¨­:å®¿æ³Š"},
            {"english": "expense", "japanese": "è²»ç”¨,å‡ºè²»"},
            {"english": "plus", "japanese": "ãã®ã†ãˆã€ã—ã‹ã‚‚"},
            {"english": "excitement", "japanese": "èˆˆå¥®;åˆºæ¿€"},
            {"english": "besides", "japanese": "ãã®ã†ãˆã€ãã‚Œã«ãªã‚“ã¨ã„ã£ã¦ã‚‚"},
            {"english": "book", "japanese": "ã€œã‚’äºˆç´„ã™ã‚‹"}
        ];

        // --- STATE ---
        let vocabulary = [];
        let selectedWords = [];
        let currentWordIndex = 0;
        let learningMode = 'word';
        let quizQuestions = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let incorrectAnswers = [];

        // --- AUDIO STATE ---
        let mediaRecorder;
        let audioChunks = [];
        let recordedAudioURL = null;
        let micStream = null;
        let synth = window.speechSynthesis;
        let voices = [];
        let recognition;

        // --- PDF STATE ---
        let wordsForPdf = [];

        // --- DOM ELEMENTS ---
        const sections = {
            setup: document.getElementById('setup-section'),
            learning: document.getElementById('learning-section'),
            testOptions: document.getElementById('test-options-section'),
            quiz: document.getElementById('quiz-section'),
            results: document.getElementById('results-section'),
        };
        const wordListContainer = document.getElementById('word-list');
        const startLearningBtn = document.getElementById('start-learning-btn');
        const loadingOverlay = document.getElementById('loading-overlay');
        const downloadPdfBtn = document.getElementById('download-pdf-btn');
        const pdfModal = document.getElementById('pdf-modal');
        const flashcardContainer = document.getElementById('flashcard-container');
        const englishText = document.getElementById('english-text');
        const japaneseText = document.getElementById('japanese-text');
        const progressIndicator = document.getElementById('progress-indicator');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const startTestBtn = document.getElementById('start-test-btn');
        const speakBtn = document.getElementById('speak-btn');
        const recordBtn = document.getElementById('record-btn');
        const playRecordingBtn = document.getElementById('play-recording-btn');
        const recordingPlayer = document.getElementById('recording-player');
        const pronunciationFeedbackContainer = document.getElementById('pronunciation-feedback-container');

        // --- ãƒ«ãƒ¼ãƒ«â‘£: ä¾‹æ–‡ç”Ÿæˆ APIé–¢é€£ ---
        const apiKey = ""; // APIã‚­ãƒ¼ã¯Canvasç’°å¢ƒã§è‡ªå‹•çš„ã«æä¾›ã•ã‚Œã¾ã™
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        async function fetchWithRetry(payload, retries = 3, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const result = await response.json();
                    
                    if (result.candidates && result.candidates[0]?.content?.parts[0]?.text) {
                        const jsonText = result.candidates[0].content.parts[0].text;
                        return JSON.parse(jsonText);
                    } else {
                        console.error("Invalid API response structure:", result);
                        throw new Error("Invalid API response structure.");
                    }
                } catch (error) {
                    // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã¯ã‚¨ãƒ©ãƒ¼ã‚’è¨˜éŒ²ã—ã¾ã›ã‚“ï¼ˆæŒ‡ç¤ºã«ã‚ˆã‚‹ï¼‰
                    if (i < retries - 1) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; // Exponential backoff
                    } else {
                        throw error; // æœ€çµ‚çš„ãªã‚¨ãƒ©ãƒ¼ã¯ã‚¹ãƒ­ãƒ¼ã™ã‚‹
                    }
                }
            }
        }

        async function generateExampleSentences(words) {
            const systemPrompt = "ã‚ãªãŸã¯è‹±èªå­¦ç¿’ã®å°‚é–€å®¶ã§ã™ã€‚æä¾›ã•ã‚ŒãŸè‹±å˜èªã¾ãŸã¯ãƒ•ãƒ¬ãƒ¼ã‚ºã¨æ—¥æœ¬èªè¨³ã®ãƒªã‚¹ãƒˆã«åŸºã¥ãã€å„é …ç›®ã«å¯¾å¿œã™ã‚‹è‡ªç„¶ãªè‹±èªã®ä¾‹æ–‡ï¼ˆsentenceï¼‰ã¨ã€ãã®æ­£ç¢ºãªæ—¥æœ¬èªè¨³ï¼ˆsentence_jaï¼‰ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚ä¾‹æ–‡ã¯ã€å…ƒã®å˜èª/ãƒ•ãƒ¬ãƒ¼ã‚ºãŒè‡ªç„¶ã«ä½¿ã‚ã‚Œã‚‹æ–‡è„ˆã«ã—ã¦ãã ã•ã„ã€‚JSONã‚¹ã‚­ãƒ¼ãƒã«å³å¯†ã«å¾“ã£ã¦é…åˆ—ã¨ã—ã¦å›ç­”ã—ã¦ãã ã•ã„ã€‚";
            
            // APIã«æ¸¡ã™ã®ã¯å¿…è¦ãªæƒ…å ±ã®ã¿
            const userQuery = JSON.stringify(words.map(w => ({ english: w.english, japanese: w.japanese })));

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                "english": { "type": "STRING" },
                                "japanese": { "type": "STRING" },
                                "sentence": { "type": "STRING" },
                                "sentence_ja": { "type": "STRING" }
                            },
                            required: ["english", "japanese", "sentence", "sentence_ja"]
                        }
                    }
                }
            };

            return await fetchWithRetry(payload);
        }

        // --- FUNCTIONS ---
        function switchSection(sectionToShow) {
            Object.values(sections).forEach(section => section.classList.add('hidden'));
            if (sections[sectionToShow]) {
                sections[sectionToShow].classList.remove('hidden');
            }
        }

        function populateWordList() {
            wordListContainer.innerHTML = '';
            vocabulary.forEach((word, index) => {
                const label = document.createElement('label');
                label.className = 'flex items-center space-x-2 p-2 rounded-md hover:bg-gray-100 cursor-pointer text-sm';
                label.innerHTML = `
                    <input type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 word-checkbox" data-index="${index}">
                    <span>${word.english}</span>
                `;
                wordListContainer.appendChild(label);
            });
        }
        
        // ä¾‹æ–‡ä¸­ã®ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆã™ã‚‹é–¢æ•°ï¼ˆå…ƒã®ã‚³ãƒ¼ãƒ‰ã‹ã‚‰æµç”¨ï¼‰
        function highlightPhraseInSentence(sentence, phrase) {
            const cleanPhrase = phrase
                .replace(/\(.*\)|~|\?|\+/g, '')
                .replace(/ S' \+ V'| O from -ing| O to do| A as B| A as well as B| S \+ seem\(s\) \+ to do/g, '')
                .replace(/\.\.\. that/g, '')
                .replace(/\[quantity\] of/g, 'of')
                .replace(/\bone's\b/g, '\\w+\'s')
                .trim();
            
            const words = cleanPhrase.split(/\s+/);
            const firstWord = words[0];
            const restOfWords = words.slice(1);

            const irregulars = {
                get: '(get|gets|getting|got|gotten)',
                be: '(is|am|are|was|were|be|being|been)',
                do: '(do|does|doing|did|done)',
                have: '(has|have|having|had)',
                eat: '(eat|eats|eating|ate|eaten)',
                finish: '(finish|finishes|finishing|finished)',
                seem: '(seem|seems|seeming|seemed)',
                tie: '(tie|ties|tying|tied)',
                hand: '(hand|hands|handing|handed)',
                turn: '(turn|turns|turning|turned)',
            };

            let firstWordRegex;
            if (irregulars[firstWord.toLowerCase()]) {
                firstWordRegex = `\\b${irregulars[firstWord.toLowerCase()]}\\b`;
            } else if (/\w+/.test(firstWord)) {
                // 's' 'es' 'ed' 'ing' ä»¥å¤–ã«ã‚‚å¯¾å¿œã§ãã‚‹ã‚ˆã†ã«
                const rootWord = firstWord.replace(/s$/, '').replace(/es$/, '').replace(/ed$/, '').replace(/ing$/, '');
                firstWordRegex = `\\b${rootWord}(s|es|ed|ing)?\\b`;
            } else {
                firstWordRegex = `\\b${firstWord.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')}\\b`;
            }

            let finalRegex;
            if (restOfWords.length > 0) {
                const restRegex = restOfWords.map(w => w.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')).join('\\s+');
                finalRegex = new RegExp(`(${firstWordRegex}\\s+${restRegex})`, 'gi');
            } else {
                finalRegex = new RegExp(`(${firstWordRegex})`, 'gi');
            }
            
            if (finalRegex.test(sentence)) {
                return sentence.replace(finalRegex, `<strong><u>$1</u></strong>`);
            }
            
            const fallbackRegex = new RegExp(`(${cleanPhrase.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')})`, 'gi');
            if(fallbackRegex.test(sentence)){
                 return sentence.replace(fallbackRegex, `<strong><u>$1</u></strong>`);
            }

            return sentence;
        }

        function updateLearningView() {
            const word = selectedWords[currentWordIndex];
            // å­¦ç¿’ãƒ¢ãƒ¼ãƒ‰ã¯ 'startLearningBtn' ã‚¯ãƒªãƒƒã‚¯æ™‚ã«ç¢ºå®šã—ã¦ã„ã‚‹
            
            // ãƒ«ãƒ¼ãƒ«â‘£: ä¾‹æ–‡ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹ã‹ç¢ºèªã—ã€ã‚ã‚Œã°è¡¨ç¤ºã€‚ãªã‘ã‚Œã°ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã€‚
            if (learningMode === 'sentence' && word.sentence && word.sentence_ja) {
                let sentenceJa = word.sentence_ja;
                const japanesePhrase = word.japanese.split(/[(ï¼ˆ]/)[0].trim();
                if (sentenceJa.includes(japanesePhrase)) {
                    japaneseText.innerHTML = sentenceJa.replace(new RegExp(japanesePhrase, 'g'), `<strong><u>${japanesePhrase}</u></strong>`);
                } else {
                    japaneseText.textContent = sentenceJa;
                }
                englishText.innerHTML = highlightPhraseInSentence(word.sentence, word.english);
            } else {
                // ä¾‹æ–‡ãŒãªã„å ´åˆã‚„å˜èªãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯ã€å˜èªã¨è¨³ã‚’è¡¨ç¤º
                englishText.innerHTML = word.english;
                japaneseText.textContent = word.japanese;
            }
            
            japaneseText.classList.add('hidden');
            pronunciationFeedbackContainer.innerHTML = '';
            progressIndicator.textContent = `${currentWordIndex + 1} / ${selectedWords.length}`;

            prevBtn.disabled = currentWordIndex === 0;
            nextBtn.disabled = currentWordIndex === selectedWords.length - 1;
            prevBtn.classList.toggle('btn-disabled', prevBtn.disabled);
            nextBtn.classList.toggle('btn-disabled', nextBtn.disabled);

            playRecordingBtn.disabled = true;
            playRecordingBtn.classList.add('btn-disabled');
            recordedAudioURL = null;
        }

        // ãƒ«ãƒ¼ãƒ«â‘¥: éŸ³å£°é¸æŠãƒ­ã‚¸ãƒƒã‚¯ï¼ˆå…ƒã®ã‚³ãƒ¼ãƒ‰ã‹ã‚‰æµç”¨ï¼‰
        function loadVoices() {
            voices = synth.getVoices();
             if (voices.length === 0) {
                setTimeout(loadVoices, 100);
            }
        }

        function speak(text) {
             if (synth.speaking) {
                return;
            }
            const cleanText = text.replace(/<[^>]*>/g, '');
            const utterance = new SpeechSynthesisUtterance(cleanText);
            
            // ãƒ«ãƒ¼ãƒ«â‘¥: æœ€ã‚‚å“è³ªã®é«˜ã„è‡ªç„¶ãªã‚¢ãƒ¡ãƒªã‚«è‹±èªã®éŸ³å£°ã‚’é¸æŠ
            let selectedVoice = voices.find(voice => voice.name === 'Google US English') || voices.find(voice => voice.lang === 'en-US' && voice.name.includes('Google')) || voices.find(voice => voice.lang === 'en-US');
            
            if (selectedVoice) {
                utterance.voice = selectedVoice;
            } else {
                 // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ä¾å­˜ï¼‰
            }
            
            utterance.lang = 'en-US';
            synth.speak(utterance);
        }

        function showTestOptions() {
            const numSelected = selectedWords.length;
            const testChoicesContainer = document.getElementById('test-choices');
            testChoicesContainer.innerHTML = '';

            const options = [];
            if (numSelected >= 10) options.push(10);
            if (numSelected >= 20) options.push(20);
            
            if (options.length === 0 && numSelected > 0) {
                 options.push(numSelected);
            } else if (numSelected > 0 && !options.includes(numSelected)) {
                 options.push(numSelected);
            }

            if (options.length > 0) {
                options.sort((a,b)=> a-b).forEach(num => {
                    const button = document.createElement('button');
                    button.className = 'btn btn-primary text-lg';
                    button.textContent = `${num}å•`;
                    button.onclick = () => generateTest(num);
                    testChoicesContainer.appendChild(button);
                });
            } else {
                testChoicesContainer.innerHTML = `<p class="text-red-500">ãƒ†ã‚¹ãƒˆã‚’è¡Œã†ã«ã¯ã€å°‘ãªãã¨ã‚‚1ã¤ã®å˜èªã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p>`;
            }
            switchSection('testOptions');
        }

        function generateTest(numQuestions) {
            quizQuestions = [];
            score = 0;
            currentQuestionIndex = 0;
            incorrectAnswers = [];
            
            const shuffled = [...selectedWords].sort(() => 0.5 - Math.random());
            const questions = shuffled.slice(0, numQuestions);

            quizQuestions = questions.map(q => {
                const correctAnswer = q.japanese;
                let options = [correctAnswer];

                // é¸æŠè‚¢ã®é‡è¤‡ã‚’é¿ã‘ã‚‹ãŸã‚ã€vocabularyDataå…¨ä½“ã‹ã‚‰å‚ç…§ã™ã‚‹
                while (options.length < 4) {
                    const randomWord = vocabulary[Math.floor(Math.random() * vocabulary.length)];
                    if (!options.includes(randomWord.japanese)) {
                        options.push(randomWord.japanese);
                    }
                }
                return {
                    question: q.english,
                    correct: correctAnswer,
                    options: options.sort(() => 0.5 - Math.random())
                };
            });
            
            displayQuizQuestion();
            switchSection('quiz');
        }

        function displayQuizQuestion() {
            const q = quizQuestions[currentQuestionIndex];
            document.getElementById('quiz-question').textContent = q.question;
            const optionsContainer = document.getElementById('quiz-options');
            optionsContainer.innerHTML = '';

            q.options.forEach(option => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'quiz-option';
                optionDiv.textContent = option;
                optionDiv.onclick = () => selectAnswer(optionDiv, option, q.correct);
                optionsContainer.appendChild(optionDiv);
            });
            
            document.getElementById('quiz-progress').textContent = `${currentQuestionIndex + 1} / ${quizQuestions.length}`;
            document.getElementById('feedback').textContent = '';
            document.getElementById('next-question-btn').classList.add('hidden');
        }

        function selectAnswer(element, selectedAnswer, correctAnswer) {
            document.querySelectorAll('.quiz-option').forEach(opt => {
                opt.onclick = null;
                opt.style.cursor = 'default';
            });
            
            const feedbackEl = document.getElementById('feedback');
            
            if (selectedAnswer === correctAnswer) {
                element.classList.add('correct');
                feedbackEl.textContent = 'æ­£è§£ï¼';
                feedbackEl.className = 'text-center text-xl font-bold my-4 min-h-[30px] text-green-600';
                score++;
            } else {
                element.classList.add('incorrect');
                feedbackEl.textContent = `ä¸æ­£è§£... æ­£è§£ã¯ã€Œ${correctAnswer}ã€`;
                feedbackEl.className = 'text-center text-xl font-bold my-4 min-h-[30px] text-red-600';
                incorrectAnswers.push({
                    question: quizQuestions[currentQuestionIndex].question,
                    correct: correctAnswer,
                    yourAnswer: selectedAnswer,
                });
                 document.querySelectorAll('.quiz-option').forEach(opt => {
                     if (opt.textContent === correctAnswer) {
                         opt.classList.add('correct');
                     }
                 });
            }
            document.getElementById('next-question-btn').classList.remove('hidden');
        }
        
        function showResults() {
            document.getElementById('score').textContent = `${score} / ${quizQuestions.length}`;
            const list = document.getElementById('incorrect-answers-list');
            list.innerHTML = '';

            if (incorrectAnswers.length > 0) {
                document.getElementById('incorrect-answers-container').classList.remove('hidden');
                incorrectAnswers.forEach(item => {
                    const li = document.createElement('li');
                    li.innerHTML = `<strong>${item.question}</strong><br>æ­£è§£: ${item.correct} (ã‚ãªãŸã®è§£ç­”: ${item.yourAnswer})`;
                    list.appendChild(li);
                });
            } else {
                 document.getElementById('incorrect-answers-container').classList.add('hidden');
                 // å…¨å•æ­£è§£æ™‚ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’å‰Šé™¤ï¼ˆé‡è¤‡è¿½åŠ ã‚’é˜²ããŸã‚ï¼‰
                 const oldFeedback = document.getElementById('score').nextElementSibling;
                 if (oldFeedback && oldFeedback.tagName === 'P' && oldFeedback.textContent.includes('å…¨å•æ­£è§£')) {
                    oldFeedback.remove();
                 }
                 document.getElementById('score').insertAdjacentHTML('afterend', '<p class="text-2xl text-green-600 font-bold mt-4">å…¨å•æ­£è§£ï¼ç´ æ™´ã‚‰ã—ã„ï¼</p>');
            }
            switchSection('results');
        }

        // --- PDFé–¢é€£ ---

        // PDFç”¨ã®å˜èªãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™ã™ã‚‹ï¼ˆä¾‹æ–‡ç”Ÿæˆã‚’å«ã‚€ï¼‰
        async function prepareWordsForPdf() {
            const checkedBoxes = document.querySelectorAll('.word-checkbox:checked');
            if (checkedBoxes.length === 0) {
                alert('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹å˜èªã‚’1ã¤ä»¥ä¸Šé¸æŠã—ã¦ãã ã•ã„ã€‚');
                return false;
            }
            
            wordsForPdf = [];
            checkedBoxes.forEach(cb => {
                // vocabularyDataã‹ã‚‰ã‚¯ãƒªãƒ¼ãƒ³ãªã‚³ãƒ”ãƒ¼ã‚’ä½œæˆ
                wordsForPdf.push({...vocabulary[cb.dataset.index]});
            });
            
            // é¸æŠã•ã‚ŒãŸå˜èªã«ä¾‹æ–‡ãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã‚‹ã‹ç¢ºèª
            const needsSentences = wordsForPdf.some(w => !w.sentence);
            
            if (needsSentences) {
                // ç°¡æ˜“ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«å†…ï¼‰
                const modalContent = pdfModal.querySelector('.mt-3');
                modalContent.insertAdjacentHTML('afterbegin', '<div id="pdf-loading" class="text-center p-4"><i class="fas fa-spinner fa-spin text-2xl text-blue-600"></i><p>ä¾‹æ–‡ã‚’æº–å‚™ä¸­ã§ã™...</p></div>');
                
                try {
                    const generatedData = await generateExampleSentences(wordsForPdf);
                    const generatedMap = new Map(generatedData.map(item => [item.english.toLowerCase(), item]));
                    
                    wordsForPdf = wordsForPdf.map(word => {
                        const generated = generatedMap.get(word.english.toLowerCase());
                        if (generated) {
                            return generated; // APIã‹ã‚‰ã®å®Œå…¨ãªãƒ‡ãƒ¼ã‚¿ï¼ˆä¾‹æ–‡å«ã‚€ï¼‰
                        }
                        return word; // ãƒãƒƒãƒã—ãªã‹ã£ãŸå ´åˆï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
                    });
                } catch (error) {
                    console.error("PDFç”¨ã®ä¾‹æ–‡ç”Ÿæˆã«å¤±æ•—:", error);
                    alert("ä¾‹æ–‡ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ä¾‹æ–‡é–¢é€£ã®PDFã¯ã€ä¾‹æ–‡ãªã—ã§ä½œæˆã•ã‚Œã‚‹ã‹ã€ä½œæˆã§ããªã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚");
                    // ã‚¨ãƒ©ãƒ¼æ™‚ã¯å…ƒã®ï¼ˆä¾‹æ–‡ãªã—ï¼‰ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
                } finally {
                    document.getElementById('pdf-loading')?.remove();
                }
            }
            
            return true;
        }


        function getSelectedWordsForPdf() {
            // prepareWordsForPdf ã§è¨­å®šã•ã‚ŒãŸ wordsForPdf ã‚’è¿”ã™
            if (wordsForPdf.length === 0) {
                return null; // prepareWordsForPdfãŒæœªå®Ÿè¡Œã‹å¤±æ•—
            }
            return wordsForPdf;
        }

        function openPrintWindow(bodyContent, title) {
            const htmlContent = `
                <!DOCTYPE html>
                <html lang="ja">
                <head>
                    <meta charset="UTF-8">
                    <title>${title}</title>
                    <style>
                        body { font-family: "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif; line-height: 1.8; margin: 25px; }
                        @media print { .no-print { display: none; } }
                        h1, h2 { text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 25px; }
                        ol, ul { list-style-position: inside; padding-left: 0; }
                        li { margin-bottom: 15px; }
                        .list-container { column-count: 2; column-gap: 40px; }
                        .list-container li { -webkit-column-break-inside: avoid; page-break-inside: avoid; break-inside: avoid; }
                        @media (max-width: 700px) { .list-container { column-count: 1; } }
                        .answer-key { page-break-before: always; }
                        ol { list-style-type: decimal; }
                    </style>
                </head>
                <body>
                    <h1>${title}</h1>
                    <p class="no-print" style="text-align:center;">
                        å°åˆ·ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œãªã„å ´åˆã¯ã€ãƒ–ãƒ©ã‚¦ã‚¶ã®å°åˆ·æ©Ÿèƒ½ï¼ˆCtrl+Pã¾ãŸã¯Cmd+Pï¼‰ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚
                    </p>
                    ${bodyContent}
                </body>
                </html>
            `;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(htmlContent);
            printWindow.document.close();
            setTimeout(() => {
                printWindow.print();
            }, 250);
        }

        // ãƒ«ãƒ¼ãƒ«â‘§: ç™ºéŸ³è©•ä¾¡ï¼ˆå…ƒã®ã‚³ãƒ¼ãƒ‰ã‹ã‚‰æµç”¨ã€ç”˜ã‚ã®æ¡ç‚¹ï¼‰
        function scorePronunciation(transcript, target) {
            const normalizedTranscript = transcript.toLowerCase().replace(/[.,?!'~]/g, '').trim();
            // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰ä¸è¦ãªè¨˜å·ã‚„æŒ‡ç¤ºèªã‚’å‰Šé™¤
            const normalizedTarget = target.toLowerCase().replace(/[.,?!'~+]/g, '').replace(/\[.*?\]/g, '').replace(/\(.+?\)/g, '').replace(/\b(s|o|we|one's)\b/gi,'').replace(/~|\/|\+/g, ' ').replace(/\s{2,}/g, ' ').trim();
            
            pronunciationFeedbackContainer.innerHTML = '';

            const targetWords = normalizedTarget.split(/\s+/).filter(w => w.length > 0);
            const transcriptWords = normalizedTranscript.split(/\s+/).filter(w => w.length > 0);
            
            if (targetWords.length === 0 || transcriptWords.length === 0) {
                pronunciationFeedbackContainer.textContent = 'ã‚‚ã†ä¸€å›ï¼ ğŸ”„';
                pronunciationFeedbackContainer.className = 'pronunciation-feedback feedback-retry';
                return;
            }

            let correctWords = 0;
            const targetWordSet = new Set(targetWords);
            transcriptWords.forEach(word => {
                if (targetWordSet.has(word)) {
                    correctWords++;
                }
            });
            
            // å˜ç´”ãªä¸€è‡´ç‡ã§ã¯ãªãã€å˜èªæ•°ã«åŸºã¥ã„ãŸä¸€è‡´ç‡ã‚’è¨ˆç®—
            const rawSimilarity = targetWords.length > 0 ? (correctWords / targetWords.length) : 0;

            // å…ƒã®ã‚³ãƒ¼ãƒ‰ã®ç”˜ã‚ã®æ¡ç‚¹ãƒ­ã‚¸ãƒƒã‚¯
            const baseScore = 65;
            const boostedScore = baseScore + (rawSimilarity * (100 - baseScore));
            const score = Math.min(100, Math.round(boostedScore));

            let feedbackText = '';
            let feedbackClass = '';

            // 3æ®µéšè©•ä¾¡
            if (score >= 95) {
                feedbackText = `ã™ã”ã„ï¼ ğŸ‘`;
                feedbackClass = 'feedback-great';
            } else if (score >= 80) {
                feedbackText = `ã„ã„ã­ï¼ ğŸ‘`;
                feedbackClass = 'feedback-good';
            } else {
                feedbackText = `ã‚‚ã†ä¸€å›ï¼ ğŸ”„`;
                feedbackClass = 'feedback-retry';
            }

            pronunciationFeedbackContainer.innerHTML = `ç™ºéŸ³ã‚¹ã‚³ã‚¢: <span class="text-3xl">${score}</span>ç‚¹ (${feedbackText})`;
            pronunciationFeedbackContainer.className = `pronunciation-feedback ${feedbackClass}`;
        }


        function initializeSpeechRecognition() {
            window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (window.SpeechRecognition) {
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.lang = 'en-US';
                recognition.interimResults = false;
                recognition.maxAlternatives = 1;

                recognition.onresult = (event) => {
                    const transcript = event.results[event.results.length - 1][0].transcript.trim();
                    const currentWord = selectedWords[currentWordIndex];
                    // ä¾‹æ–‡ãƒ¢ãƒ¼ãƒ‰ã§ä¾‹æ–‡ãŒã‚ã‚Œã°ä¾‹æ–‡ã‚’ã€ãªã‘ã‚Œã°å˜èªã‚’ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã«ã™ã‚‹
                    let targetText = currentWord.english;
                    if (learningMode === 'sentence' && currentWord.sentence) {
                        targetText = currentWord.sentence.replace(/<[^>]*>/g, '').trim();
                    }
                    scorePronunciation(transcript, targetText);
                };

                recognition.onerror = (event) => {
                    console.error('Speech recognition error:', event.error);
                    let errorMessage = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
                    if (event.error === 'no-speech') {
                        errorMessage = 'éŸ³å£°ãŒæ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚';
                    } else if (event.error === 'audio-capture') {
                        errorMessage = 'ãƒã‚¤ã‚¯ã«å•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
                    } else if (event.error === 'not-allowed') {
                        errorMessage = 'ãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚';
                    }
                    pronunciationFeedbackContainer.textContent = errorMessage;
                    pronunciationFeedbackContainer.className = 'pronunciation-feedback feedback-retry';
                };
            } else {
                console.warn("Speech Recognition not supported in this browser.");
                recordBtn.disabled = true;
                recordBtn.classList.add('btn-disabled');
                recordBtn.innerHTML = '<i class="fas fa-microphone-slash mr-2"></i>éŒ²éŸ³ä¸å¯';
            }
        }

        // --- EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            vocabulary = vocabularyData;
            populateWordList();
            
            if (typeof speechSynthesis !== 'undefined' && speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = loadVoices;
            }
            loadVoices();
            initializeSpeechRecognition();
        });

        flashcardContainer.addEventListener('click', () => {
            japaneseText.classList.toggle('hidden');
        });

        document.getElementById('select-all').addEventListener('click', () => {
            document.querySelectorAll('.word-checkbox').forEach(cb => cb.checked = true);
        });

        document.getElementById('deselect-all').addEventListener('click', () => {
            document.querySelectorAll('.word-checkbox').forEach(cb => cb.checked = false);
        });

        // ãƒ«ãƒ¼ãƒ«â‘£: å­¦ç¿’é–‹å§‹ãƒœã‚¿ãƒ³ã®ãƒªã‚¹ãƒŠãƒ¼ã‚’éåŒæœŸï¼ˆasyncï¼‰ã«å¤‰æ›´
        startLearningBtn.addEventListener('click', async () => {
            const checkedBoxes = document.querySelectorAll('.word-checkbox:checked');
            if (checkedBoxes.length === 0) {
                alert('å­¦ç¿’ã™ã‚‹å˜èªã‚’1ã¤ä»¥ä¸Šé¸æŠã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            const wordsToLearn = [];
            checkedBoxes.forEach(cb => {
                // vocabularyDataã‹ã‚‰ã‚¯ãƒªãƒ¼ãƒ³ãªã‚³ãƒ”ãƒ¼ã‚’ä½œæˆ
                wordsToLearn.push({...vocabulary[cb.dataset.index]});
            });
            
            learningMode = document.querySelector('input[name="mode"]:checked').value;
            
            // ä¾‹æ–‡ãƒ¢ãƒ¼ãƒ‰ãŒé¸æŠã•ã‚ŒãŸå ´åˆã®ã¿APIã‚’å‘¼ã³å‡ºã™
            if (learningMode === 'sentence') {
                loadingOverlay.classList.remove('hidden');
                try {
                    const generatedData = await generateExampleSentences(wordsToLearn);
                    // APIãŒè¿”ã—ãŸé †åºãŒå…¥åŠ›ã¨ä¸€è‡´ã™ã‚‹ã¨ã¯é™ã‚‰ãªã„ãŸã‚ã€ãƒãƒƒãƒ”ãƒ³ã‚°ã™ã‚‹
                    const generatedMap = new Map(generatedData.map(item => [item.english.toLowerCase(), item]));
                    
                    selectedWords = wordsToLearn.map(word => {
                        const generated = generatedMap.get(word.english.toLowerCase());
                        if (generated) {
                            return generated; // APIã‹ã‚‰ã®å®Œå…¨ãªãƒ‡ãƒ¼ã‚¿ï¼ˆä¾‹æ–‡å«ã‚€ï¼‰
                        }
                        return word; // ãƒãƒƒãƒã—ãªã‹ã£ãŸå ´åˆï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
                    });
                    
                } catch (error) {
                    console.error("ä¾‹æ–‡ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
                    alert("ä¾‹æ–‡ã®ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚å˜èªãƒ¢ãƒ¼ãƒ‰ã§å­¦ç¿’ã‚’é–‹å§‹ã—ã¾ã™ã€‚");
                    // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ä¾‹æ–‡ãªã—ã§ç¶šè¡Œ
                    selectedWords = wordsToLearn;
                    document.querySelector('input[name="mode"][value="word"]').checked = true; // ãƒ¢ãƒ¼ãƒ‰ã‚’å¼·åˆ¶çš„ã«å˜èªã«
                    learningMode = 'word'; // çŠ¶æ…‹å¤‰æ•°ã‚‚æ›´æ–°
                } finally {
                    loadingOverlay.classList.add('hidden');
                }
            } else {
                // å˜èªãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯APIã‚’å‘¼ã³å‡ºã•ãªã„
                selectedWords = wordsToLearn;
            }

            currentWordIndex = 0;
            updateLearningView(); // updateLearningViewã¯ä¾‹æ–‡ãŒãªãã¦ã‚‚å˜èªã‚’è¡¨ç¤ºã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ãŒæ—¢ã«ã‚ã‚‹
            switchSection('learning');
        });

        // ãƒ«ãƒ¼ãƒ«â‘£: PDFãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®ãƒªã‚¹ãƒŠãƒ¼ã‚’éåŒæœŸã«å¤‰æ›´
        downloadPdfBtn.addEventListener('click', async () => {
            const success = await prepareWordsForPdf();
            if (success) {
                // ä¾‹æ–‡PDFç”¨ã®å˜èªãƒ‡ãƒ¼ã‚¿ãŒæº–å‚™ã§ãã¦ã‹ã‚‰ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
                pdfModal.classList.remove('hidden');
            }
        });
        document.getElementById('close-modal-btn').addEventListener('click', () => pdfModal.classList.add('hidden'));
        
        // --- PDF DOWNLOAD LISTENERS (å…ƒã®ã‚³ãƒ¼ãƒ‰ã‚’æµç”¨) ---
        // ãƒ«ãƒ¼ãƒ«â‘¦: ç•ªå·é‡è¤‡ã®ãªã„ãƒªã‚¹ãƒˆç”Ÿæˆ
        document.getElementById('download-list-btn').addEventListener('click', () => {
            const words = getSelectedWordsForPdf(); // æº–å‚™æ¸ˆã¿ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            if (!words) return;
            const listItems = words.map(word => {
                let item = `<li><strong>${word.english}</strong>: ${word.japanese}`;
                // ä¾‹æ–‡ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°è¿½åŠ 
                if (word.sentence && word.sentence_ja) {
                    item += `<br><small style="color:#555;">${word.sentence} (${word.sentence_ja})</small>`;
                }
                item += `</li>`;
                return item;
            }).join('');
            openPrintWindow(`<ul class="list-container">${listItems}</ul>`, 'é‡è¦èªå¥ãƒªã‚¹ãƒˆ');
            pdfModal.classList.add('hidden');
        });

        document.getElementById('download-en-quiz-btn').addEventListener('click', () => {
            const words = getSelectedWordsForPdf();
            if (!words) return;
            const quizItems = words.map(word => `<li>${word.japanese}: _________________________</li>`).join('');
            const answerItems = words.map(word => `<li>${word.english}</li>`).join('');
            const bodyContent = `<h2>å•é¡Œç”¨ç´™</h2><ol class="list-container">${quizItems}</ol><div class="answer-key"><h2>è§£ç­”</h2><ol class="list-container">${answerItems}</ol></div>`;
            openPrintWindow(bodyContent, 'é‡è¦èªå¥ãƒ†ã‚¹ãƒˆ (è‹±èªã‚’è§£ç­”)');
            pdfModal.classList.add('hidden');
        });

        document.getElementById('download-ja-quiz-btn').addEventListener('click', () => {
            const words = getSelectedWordsForPdf();
            if (!words) return;
            const quizItems = words.map(word => `<li>${word.english}: _________________________</li>`).join('');
            const answerItems = words.map(word => `<li>${word.japanese}</li>`).join('');
            const bodyContent = `<h2>å•é¡Œç”¨ç´™</h2><ol class="list-container">${quizItems}</ol><div class="answer-key"><h2>è§£ç­”</h2><ol class="list-container">${answerItems}</ol></div>`;
            openPrintWindow(bodyContent, 'é‡è¦èªå¥ãƒ†ã‚¹ãƒˆ (æ—¥æœ¬èªã‚’è§£ç­”)');
            pdfModal.classList.add('hidden');
        });

        document.getElementById('download-mixed-quiz-btn').addEventListener('click', () => {
            const words = getSelectedWordsForPdf();
            if (!words) return;
            let quizItems = '';
            let answerItems = '';
            const shuffled = [...words].sort(() => 0.5 - Math.random());
            shuffled.forEach(word => {
                if (Math.random() > 0.5) {
                    quizItems += `<li>${word.japanese}: _________________________</li>`;
                    answerItems += `<li>${word.english}</li>`;
                } else {
                    quizItems += `<li>${word.english}: _________________________</li>`;
                    answerItems += `<li>${word.japanese}</li>`;
                }
            });
            const bodyContent = `<h2>å•é¡Œç”¨ç´™</h2><ol class="list-container">${quizItems}</ol><div class="answer-key"><h2>è§£ç­”</h2><ol class="list-container">${answerItems}</ol></div>`;
            openPrintWindow(bodyContent, 'é‡è¦èªå¥ãƒ†ã‚¹ãƒˆ (æ··åˆ)');
            pdfModal.classList.add('hidden');
        });

        document.getElementById('download-sentence-quiz-btn').addEventListener('click', () => {
            const words = getSelectedWordsForPdf();
            if (!words) return;
            
            const wordsForQuiz = words.filter(w => w.sentence); // ä¾‹æ–‡ãŒã‚ã‚‹ã‚‚ã®ã ã‘
             if(wordsForQuiz.length === 0) {
                alert('é¸æŠã•ã‚ŒãŸå˜èªã«ã¯ã€ç©´åŸ‹ã‚å•é¡Œã‚’ä½œæˆã§ãã‚‹ä¾‹æ–‡ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ï¼ˆä¾‹æ–‡ç”Ÿæˆã«å¤±æ•—ã—ãŸã‹ã€å¯¾è±¡å˜èªãŒã‚ã‚Šã¾ã›ã‚“ï¼‰');
                return;
            }

            let quizItems = '';
            let answerItems = '';
            for(const word of wordsForQuiz) {
                // ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã‚’å¿œç”¨ã—ã¦ã€ãƒ•ãƒ¬ãƒ¼ã‚ºéƒ¨åˆ†ã‚’ç©ºç™½ã«ã™ã‚‹
                const blankedSentence = highlightPhraseInSentence(word.sentence, word.english)
                                        .replace(/<strong><u>.*?<\/u><\/strong>/gi, '_______________');
                quizItems += `<li>${blankedSentence}<br>ï¼ˆãƒ’ãƒ³ãƒˆ: ${word.japanese}ï¼‰</li>`;
                answerItems += `<li>${word.english}</li>`;
            }

            const bodyContent = `<h2>å•é¡Œç”¨ç´™</h2><ol>${quizItems}</ol><div class="answer-key"><h2>è§£ç­”</h2><ol class="list-container">${answerItems}</ol></div>`;
            openPrintWindow(bodyContent, 'é‡è¦èªå¥ãƒ†ã‚¹ãƒˆ (ä¾‹æ–‡ç©´åŸ‹ã‚)');
            pdfModal.classList.add('hidden');
        });

        document.getElementById('download-sentence-mixed-quiz-btn').addEventListener('click', () => {
            const words = getSelectedWordsForPdf();
            if (!words) return;
            
            const wordsForQuiz = words.filter(w => w.sentence && w.sentence_ja);
            if (wordsForQuiz.length === 0) {
                alert('é¸æŠã•ã‚ŒãŸå˜èªã«ã¯ã€æ··åˆå•é¡Œã‚’ä½œæˆã§ãã‚‹ä¾‹æ–‡ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ï¼ˆä¾‹æ–‡ç”Ÿæˆã«å¤±æ•—ã—ãŸã‹ã€å¯¾è±¡å˜èªãŒã‚ã‚Šã¾ã›ã‚“ï¼‰');
                return;
            }
            
            let quizItems = '';
            let answerItems = '';
            const shuffled = [...wordsForQuiz].sort(() => 0.5 - Math.random());
            
            const instructionText = 'è‹±èªã‚’ç­”ãˆã‚‹å•é¡Œã¯æ–‡è„ˆã«å¾“ã£ã¦ãƒ’ãƒ³ãƒˆã‚’ã‚‚ã¨ã«è‹±èªã‚’ã€æ—¥æœ¬èªã‚’ç­”ãˆã‚‹å•é¡Œã¯è‹±æ–‡ã®ä¸‹ç·šéƒ¨ã®éƒ¨åˆ†ã‚’æ—¥æœ¬èªã«ç›´ã—ãªã•ã„ã€‚';
            const generalInstruction = `<p style="text-align: left; border: 1px solid #ccc; padding: 10px; margin-bottom: 20px;">${instructionText}</p>`;

            for(const word of shuffled) {
                if (Math.random() > 0.5) {
                     // ç©´åŸ‹ã‚å•é¡Œ
                     const blankedSentence = highlightPhraseInSentence(word.sentence, word.english)
                                        .replace(/<strong><u>.*?<\/u><\/strong>/gi, '_______________');
                    quizItems += `<li>${blankedSentence}<br>ï¼ˆãƒ’ãƒ³ãƒˆ: ${word.japanese}ï¼‰</li>`;
                    answerItems += `<li>${word.english}</li>`;
                } else {
                    // å’Œè¨³å•é¡Œ
                    const underlinedSentence = highlightPhraseInSentence(word.sentence, word.english)
                                        .replace(/<strong><u>(.*?)<\/u><\/strong>/gi, '<u>$1</u>'); // <strong>ã‚’é™¤å»
                    quizItems += `<li>${underlinedSentence}<br>_________________________</li>`;
                    answerItems += `<li>${word.japanese}</li>`;
                }
            }
            
            const bodyContent = `<h2>å•é¡Œç”¨ç´™</h2>${generalInstruction}<ol>${quizItems}</ol><div class="answer-key"><h2>è§£ç­”</h2><ol class="list-container">${answerItems}</ol></div>`;
            openPrintWindow(bodyContent, 'é‡è¦èªå¥ãƒ†ã‚¹ãƒˆ (ä¾‹æ–‡æ··åˆ)');
            pdfModal.classList.add('hidden');
        });


        prevBtn.addEventListener('click', () => {
            if (currentWordIndex > 0) {
                currentWordIndex--;
                updateLearningView();
            }
        });

        nextBtn.addEventListener('click', () => {
            if (currentWordIndex < selectedWords.length - 1) {
                currentWordIndex++;
                updateLearningView();
            }
        });
        
        document.getElementById('back-to-setup-btn').addEventListener('click', () => switchSection('setup'));
        
        startTestBtn.addEventListener('click', showTestOptions);

        document.getElementById('back-to-learning-btn').addEventListener('click', () => switchSection('learning'));
        
        speakBtn.addEventListener('click', () => {
            // ä¾‹æ–‡ãƒ¢ãƒ¼ãƒ‰ã§ä¾‹æ–‡ãŒã‚ã‚Œã°ä¾‹æ–‡ã‚’ã€ãªã‘ã‚Œã°å˜èªã‚’èª­ã¿ä¸Šã’ã‚‹
            const currentWord = selectedWords[currentWordIndex];
            let textToSpeak = currentWord.english;
             if (learningMode === 'sentence' && currentWord.sentence) {
                textToSpeak = currentWord.sentence;
            }
            speak(textToSpeak);
        });
        
        recordBtn.addEventListener('click', async () => {
            if (!recognition) {
                 alert("éŸ³å£°èªè­˜æ©Ÿèƒ½ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ãªã„ã‹ã€ãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
                return;
            }

            const isRecording = mediaRecorder && mediaRecorder.state === 'recording';

            if (isRecording) {
                mediaRecorder.stop();
                // onstopã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã§recognition.stop()ãŒå‘¼ã°ã‚Œã‚‹
            } else {
                try {
                    micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(micStream);
                    
                    mediaRecorder.onstart = () => {
                        audioChunks = [];
                        recordBtn.innerHTML = '<i id="mic-icon" class="fas fa-microphone mr-2 recording"></i>éŒ²éŸ³åœæ­¢';
                        recordBtn.classList.remove('btn-red');
                        recordBtn.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
                        playRecordingBtn.disabled = true;
                        playRecordingBtn.classList.add('btn-disabled');
                        pronunciationFeedbackContainer.innerHTML = '';
                    };

                    mediaRecorder.ondataavailable = event => {
                        audioChunks.push(event.data);
                    };

                    mediaRecorder.onstop = () => {
                        recognition.stop(); // éŒ²éŸ³åœæ­¢ã¨åŒæ™‚ã«éŸ³å£°èªè­˜ã‚‚åœæ­¢
                        
                        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        recordedAudioURL = URL.createObjectURL(audioBlob);
                        recordingPlayer.src = recordedAudioURL;

                        recordBtn.innerHTML = '<i id="mic-icon" class="fas fa-microphone mr-2"></i>éŒ²éŸ³';
                        recordBtn.classList.add('btn-red');
                        recordBtn.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                        
                        playRecordingBtn.disabled = false;
                        playRecordingBtn.classList.remove('btn-disabled');

                        if (micStream) {
                            micStream.getTracks().forEach(track => track.stop());
                        }
                    };
                    
                    mediaRecorder.start();
                    recognition.start(); // éŒ²éŸ³é–‹å§‹ã¨åŒæ™‚ã«éŸ³å£°èªè­˜ã‚‚é–‹å§‹

                } catch (err) {
                    console.error("Microphone access error:", err);
                    alert("ãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒè¨±å¯ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚éŒ²éŸ³æ©Ÿèƒ½ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ã€ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã§ãƒã‚¤ã‚¯ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚");
                }
            }
        });
        
        playRecordingBtn.addEventListener('click', () => {
            if (recordedAudioURL) {
                recordingPlayer.play();
            }
        });

        document.getElementById('abort-test-btn').addEventListener('click', () => switchSection('learning'));

        document.getElementById('next-question-btn').addEventListener('click', () => {
            currentQuestionIndex++;
            if (currentQuestionIndex < quizQuestions.length) {
                displayQuizQuestion();
            } else {
                showResults();
            }
        });

        document.getElementById('restart-btn').addEventListener('click', () => {
            // å…¨å•æ­£è§£æ™‚ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’å‰Šé™¤
            const scoreDisplay = document.getElementById('score');
            const oldFeedback = scoreDisplay.nextElementSibling;
            if (oldFeedback && oldFeedback.tagName === 'P' && oldFeedback.textContent.includes('å…¨å•æ­£è§£')) {
                oldFeedback.remove();
            }
            document.querySelectorAll('.word-checkbox').forEach(cb => cb.checked = false);
            switchSection('setup');
        });

    </script>
</body>
</html>
